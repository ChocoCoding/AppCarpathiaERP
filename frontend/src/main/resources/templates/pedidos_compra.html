<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Pedidos de Compra</title>
    <link rel="stylesheet" href="/css/estilos_pedidos_compra.css">
    <link rel="stylesheet" type="text/css" href="/css/estilosmodulo.css">
</head>
<body>
<header>

    <h1>Pedidos de Compra</h1>
    <div class="actions">
        <button class="back-button" onclick="goBack()">Volver Atrás</button>
        <button class="save-button" onclick="guardarCambios()">Guardar</button>
        <button class="logout-button" onclick="logout()">Cerrar Sesión</button>
    </div>
</header>
<div class="content-container">
    <h2>Lista de Pedidos de Compra</h2>
    <table>
        <thead>
        <tr>
            <th>Eliminar</th> <!-- Nueva columna para el icono de eliminación -->
            <th>ID</th>
            <th>Nº Operación</th>
            <th>Nº Contenedor</th>
            <th>Proforma</th>
            <th>Proveedor</th>
            <th>Cliente</th>
            <th>Incoterm</th>
            <th>Referencia Proveedor</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="pedido : ${pedidosCompra}" th:data-id-pedido-compra="${pedido.idPedidoCompra}">
            <td>
                <button class="delete-button" th:onclick="'eliminarPedido(' + ${pedido.idPedidoCompra} + ')'">
                    🗑️
                </button>
            </td>
            <td th:text="${pedido.idPedidoCompra}">ID</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.n_operacion}">Nº Operación</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.n_contenedor}">Nº Contenedor</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.proforma}">Proforma</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.proveedor}">Proveedor</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.cliente}">Cliente</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.incoterm}">Incoterm</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.referenciaProveedor}">Referencia Proveedor</td>
        </tr>
        </tbody>
    </table>
</div>

<script>
    // Marcar una fila como modificada
    function marcarModificado(elemento) {
        const fila = elemento.closest('tr');
        fila.classList.add('modificado');
    }

    function goBack() {
        window.history.back();
    }

    function logout() {
        window.location.href = "/logout";
    }

    function guardarCambios() {
        const filasModificadas = document.querySelectorAll('tbody tr.modificado');

        filasModificadas.forEach(fila => {
            const idPedidoCompra = fila.getAttribute('data-id-pedido-compra');
            const datos = {
                n_operacion: fila.children[2].innerText.trim(),
                n_contenedor: fila.children[3].innerText.trim(),
                proforma: fila.children[4].innerText.trim(),
                proveedor: fila.children[5].innerText.trim(),
                cliente: fila.children[6].innerText.trim(),
                incoterm: fila.children[7].innerText.trim(),
                referenciaProveedor: fila.children[8].innerText.trim()
            };

            console.log(`Enviando PUT a /api/compras/pedidos_compra/${idPedidoCompra}`);
            console.log(`Datos enviados:`, datos);

            fetch(`http://localhost:8702/api/compras/pedidos_compra/${idPedidoCompra}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
            .then(response => {
                if (response.ok) {
                    alert('Cambios guardados con éxito');
                    fila.classList.remove('modificado'); // Elimina la clase modificado
                } else {
                    alert('Error al guardar los cambios');
                }
            })
            .catch(error => {
                console.error('Error en la solicitud:', error);
                alert('Error al guardar los cambios');
            });
        });
    }

    function eliminarPedido(idPedidoCompra) {
    console.log('Eliminar pedido con ID:', idPedidoCompra);
        if (confirm("¿Estás seguro de que deseas eliminar este pedido?")) {
            fetch(`http://localhost:8702/api/compras/pedidos_compra/${idPedidoCompra}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Pedido eliminado con éxito');
                    location.reload(); // Recarga la página para reflejar los cambios
                } else {
                    alert('Error al eliminar el pedido');
                }
            })
            .catch(error => {
                console.error('Error en la solicitud:', error);
                alert('Error al eliminar el pedido');
            });
        }
    }
</script>
</body>
</html>
