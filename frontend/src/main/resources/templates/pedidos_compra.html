<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Pedidos de Compra</title>
    <link rel="stylesheet" href="/css/estilos_pedidos_compra.css">
    <link rel="stylesheet" type="text/css" href="/css/estilosmodulo.css">
    <style>
        .sortable {
            cursor: pointer;
        }
        .sortable:after {
            content: ' ▼'; /* Flecha hacia abajo como predeterminada */
        }
        .sortable.asc:after {
            content: ' ▲'; /* Flecha hacia arriba cuando se ordena ascendentemente */
        }
    </style>
</head>
<body>
<header>

    <h1>Pedidos de Compra</h1>
    <div class="actions">
        <button class="back-button" onclick="goBack()">Volver Atrás</button>
        <button class="save-button" onclick="guardarCambios()">Guardar</button>
        <button class="create-button" onclick="crearPedidoCompra()">Crear Pedido de Compra</button>
        <button class="logout-button" onclick="logout()">Cerrar Sesión</button>
    </div>
</header>
<div class="content-container">
    <h2>Lista de Pedidos de Compra</h2>
    <table>
        <thead>
        <tr>
            <th>Eliminar</th> <!-- Nueva columna para el icono de eliminación -->
            <th class="sortable" onclick="sortTable(1)">ID</th>
            <th class="sortable" onclick="sortTable(2)">Nº Operación</th>
            <th class="sortable" onclick="sortTable(3)">Nº Contenedor</th>
            <th class="sortable" onclick="sortTable(4)">Proforma</th>
            <th class="sortable" onclick="sortTable(5)">Proveedor</th>
            <th class="sortable" onclick="sortTable(6)">Cliente</th>
            <th class="sortable" onclick="sortTable(7)">Incoterm</th>
            <th class="sortable" onclick="sortTable(8)">Referencia Proveedor</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="pedido : ${pedidosCompra}" th:data-id-pedido-compra="${pedido.idPedidoCompra}">
            <td>
                <button class="delete-button" th:onclick="'eliminarPedido(' + ${pedido.idPedidoCompra} + ')'">
                    🗑️
                </button>
            </td>
            <td th:text="${pedido.idPedidoCompra}">ID</td>
            <td contenteditable="true"  tabindex="0" class="editable" oninput="marcarModificado(this)" th:text="${pedido.n_operacion}">Nº Operación</td>
            <td contenteditable="true"  tabindex="0" class="editable" oninput="marcarModificado(this)" th:text="${pedido.n_contenedor}">Nº Contenedor</td>
            <td contenteditable="true"  tabindex="0" class="editable" oninput="marcarModificado(this)" th:text="${pedido.proforma}">Proforma</td>
            <td contenteditable="true"  tabindex="0" class="editable" oninput="marcarModificado(this)" th:text="${pedido.proveedor}">Proveedor</td>
            <td contenteditable="true"  tabindex="0" class="editable" oninput="marcarModificado(this)" th:text="${pedido.cliente}">Cliente</td>
            <td contenteditable="true"  tabindex="0" class="editable" oninput="marcarModificado(this)" th:text="${pedido.incoterm}">Incoterm</td>
            <td contenteditable="true"  tabindex="0" class="editable" oninput="marcarModificado(this)" th:text="${pedido.referenciaProveedor}">Referencia Proveedor</td>
        </tr>
        </tbody>
    </table>
</div>

<script>
 function marcarModificado(elemento) {
        const fila = elemento.closest('tr');
        fila.classList.add('modificado');
    }
    function goBack() {
        window.history.back();
    }

    function logout() {
        window.location.href = "/logout";
    }

    function guardarCambios() {
    const filasModificadas = document.querySelectorAll('tbody tr.modificado');

    filasModificadas.forEach(fila => {
        const idPedidoCompra = fila.getAttribute('data-id-pedido-compra');
        const datos = {
            n_operacion: fila.children[2].innerText.trim(),
            n_contenedor: fila.children[3].innerText.trim(),
            proforma: fila.children[4].innerText.trim(),
            proveedor: fila.children[5].innerText.trim(),
            cliente: fila.children[6].innerText.trim(),
            incoterm: fila.children[7].innerText.trim(),
            referenciaProveedor: fila.children[8].innerText.trim()
        };

        if (!idPedidoCompra) {
            fetch('http://localhost:8702/api/compras/pedidos_compra', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
            .then(response => {
                if (response.ok) {
                    alert('Pedido creado con éxito');
                    location.reload();
                } else {
                    alert('Error al crear el pedido');
                }
            })
            .catch(error => {
                console.error('Error en la solicitud:', error);
                alert('Error al crear el pedido');
            });
        } else {
            fetch(`http://localhost:8702/api/compras/pedidos_compra/${idPedidoCompra}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
            .then(response => {
                if (response.ok) {
                    alert('Cambios guardados con éxito');
                    fila.classList.remove('modificado');
                    fila.classList.remove('new-row');
                } else {
                    alert('Error al guardar los cambios');
                }
            })
            .catch(error => {
                console.error('Error en la solicitud:', error);
                alert('Error al guardar los cambios');
            });
        }
    });
}


    function eliminarPedido(idPedidoCompra) {
        console.log('Eliminar pedido con ID:', idPedidoCompra);
        if (confirm("¿Estás seguro de que deseas eliminar este pedido?")) {
            fetch(`http://localhost:8702/api/compras/pedidos_compra/${idPedidoCompra}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Pedido eliminado con éxito');
                    location.reload();
                } else {
                    alert('Error al eliminar el pedido');
                }
            })
            .catch(error => {
                console.error('Error en la solicitud:', error);
                alert('Error al eliminar el pedido');
            });
        }
    }

    function crearPedidoCompra() {
        const tbody = document.querySelector('tbody');
        const nuevaFila = document.createElement('tr');

        nuevaFila.innerHTML = `
            <td>
                <button class="delete-button" onclick="eliminarFila(this)">
                    🗑️
                </button>
            </td>
            <td></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
        `;

        tbody.insertBefore(nuevaFila, tbody.firstChild);
        nuevaFila.classList.add('modificado', 'new-row');
    }

    function eliminarFila(boton) {
        const fila = boton.closest('tr');
        fila.remove();
    }

    function sortTable(columnIndex) {
    const table = document.querySelector("tbody");
    const rows = Array.from(table.querySelectorAll("tr"));
    const headerCells = document.querySelectorAll("thead th.sortable");
    const isAscending = headerCells[columnIndex - 1].classList.contains("asc");
    const newDirection = isAscending ? "desc" : "asc";

    rows.sort((a, b) => {
        const aText = a.children[columnIndex].innerText.trim();
        const bText = b.children[columnIndex].innerText.trim();

        return isAscending
            ? aText.localeCompare(bText, undefined, {numeric: true})
            : bText.localeCompare(aText, undefined, {numeric: true});
    });

    // Reinsert the sorted rows into the table
    rows.forEach(row => table.appendChild(row));

    // Update the arrow icons
    headerCells.forEach(th => th.classList.remove("asc", "desc"));
    headerCells[columnIndex - 1].classList.add(newDirection);
}

</script>
</body>
</html>
