<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Pedidos de Compra</title>
    <link rel="stylesheet" href="/css/estilos_pedidos_compra.css">
    <link rel="stylesheet" type="text/css" href="/css/estilosmodulo.css">

</head>
<body>
<header>

    <h1>Pedidos de Compra</h1>
    <div class="actions">
        <button class="back-button" onclick="goBack()">Volver Atr√°s</button>
        <button class="save-button" onclick="guardarCambios()">Guardar</button>
        <button class="create-button" onclick="crearPedidoCompra()">Crear Pedido de Compra</button>
        <button class="logout-button" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>
</header>
<div class="content-container">
    <h2>Lista de Pedidos de Compra</h2>
    <table>
        <thead>
        <tr>
            <th>Eliminar</th> <!-- Nueva columna para el icono de eliminaci√≥n -->
            <th>ID</th>
            <th>N¬∫ Operaci√≥n</th>
            <th>N¬∫ Contenedor</th>
            <th>Proforma</th>
            <th>Proveedor</th>
            <th>Cliente</th>
            <th>Incoterm</th>
            <th>Referencia Proveedor</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="pedido : ${pedidosCompra}" th:data-id-pedido-compra="${pedido.idPedidoCompra}">
            <td>
                <button class="delete-button" th:onclick="'eliminarPedido(' + ${pedido.idPedidoCompra} + ')'">
                    üóëÔ∏è
                </button>
            </td>
            <td th:text="${pedido.idPedidoCompra}">ID</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.n_operacion}">N¬∫ Operaci√≥n</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.n_contenedor}">N¬∫ Contenedor</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.proforma}">Proforma</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.proveedor}">Proveedor</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.cliente}">Cliente</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.incoterm}">Incoterm</td>
            <td contenteditable="true" class="editable" oninput="marcarModificado(this)" th:text="${pedido.referenciaProveedor}">Referencia Proveedor</td>
        </tr>
        </tbody>
    </table>
</div>

<script>
    // Marcar una fila como modificada
    function marcarModificado(elemento) {
        const fila = elemento.closest('tr');
        fila.classList.add('modificado');
    }

    function goBack() {
        window.history.back();
    }

    function logout() {
        window.location.href = "/logout";
    }

    function guardarCambios() {
        const filasModificadas = document.querySelectorAll('tbody tr.modificado');

        filasModificadas.forEach(fila => {
            const idPedidoCompra = fila.getAttribute('data-id-pedido-compra');
            const datos = {
                n_operacion: fila.children[2].innerText.trim(),
                n_contenedor: fila.children[3].innerText.trim(),
                proforma: fila.children[4].innerText.trim(),
                proveedor: fila.children[5].innerText.trim(),
                cliente: fila.children[6].innerText.trim(),
                incoterm: fila.children[7].innerText.trim(),
                referenciaProveedor: fila.children[8].innerText.trim()
            };

            // Si idPedidoCompra es null o vac√≠o, es un nuevo pedido (POST), de lo contrario es una actualizaci√≥n (PUT)
            if (!idPedidoCompra) {
                fetch('http://localhost:8702/api/compras/pedidos_compra', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                })
                .then(response => {
                    if (response.ok) {
                        alert('Pedido creado con √©xito');
                        location.reload(); // Recarga la p√°gina para mostrar la nueva fila con su ID
                    } else {
                        alert('Error al crear el pedido');
                    }
                })
                .catch(error => {
                    console.error('Error en la solicitud:', error);
                    alert('Error al crear el pedido');
                });
            } else {
                fetch(`http://localhost:8702/api/compras/pedidos_compra/${idPedidoCompra}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                })
                .then(response => {
                    if (response.ok) {
                        alert('Cambios guardados con √©xito');
                        fila.classList.remove('modificado');
                        fila.classList.remove('new-row'); // Elimina la clase new-row una vez guardado
                    } else {
                        alert('Error al guardar los cambios');
                    }
                })
                .catch(error => {
                    console.error('Error en la solicitud:', error);
                    alert('Error al guardar los cambios');
                });
            }
        });
    }

    function eliminarPedido(idPedidoCompra) {
        console.log('Eliminar pedido con ID:', idPedidoCompra);
        if (confirm("¬øEst√°s seguro de que deseas eliminar este pedido?")) {
            fetch(`http://localhost:8702/api/compras/pedidos_compra/${idPedidoCompra}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Pedido eliminado con √©xito');
                    location.reload(); // Recarga la p√°gina para reflejar los cambios
                } else {
                    alert('Error al eliminar el pedido');
                }
            })
            .catch(error => {
                console.error('Error en la solicitud:', error);
                alert('Error al eliminar el pedido');
            });
        }
    }

    function crearPedidoCompra() {
        // Crea un nuevo elemento de fila (tr) en la tabla para el nuevo pedido
        const tbody = document.querySelector('tbody');
        const nuevaFila = document.createElement('tr');

        nuevaFila.innerHTML = `
            <td>
                <button class="delete-button" onclick="eliminarFila(this)">
                    üóëÔ∏è
                </button>
            </td>
            <td></td> <!-- ID vac√≠o porque es un nuevo pedido -->
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
            <td contenteditable="true" class="editable"></td>
        `;

        // Inserta la nueva fila al principio del tbody
        tbody.insertBefore(nuevaFila, tbody.firstChild);
        nuevaFila.classList.add('modificado', 'new-row'); // Marca la fila como modificada y nueva
    }

    // Funci√≥n para eliminar una fila que a√∫n no ha sido guardada en el backend
    function eliminarFila(boton) {
        const fila = boton.closest('tr');
        fila.remove();
    }
</script>
</body>
</html>
